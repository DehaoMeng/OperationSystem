# 操作系统实验二 

同步机构

## (1)题目

模拟 PV 操作同步机构，且用 PV 操作解决生产者——消费者问题。

## (2)提示

(1) PV 操作同步机构，由 P 操作原语和 V 操作原语组成，它们的定义如下： 

P 操作原语 P(s)：将信号量 s 减去 1，若结果小于 0，则执行原语的进程被置成等待信号量 s 的状态。

V 操作原语 V(s)：将信号量 s 加 1，若结果不大于 0，则释放一个等待信号量 s 的进程。这两条原语是如下的两个过程：

~~~
procedure p (var s: semaphore);
begin s:=s-1;
if s<0 then W(s)
end {p}
procedure v (var s: semaphore);
begin s: =s+1;
if s<=0 then R(s)
end {V}
~~~

其中 W(s)表示将调用过程的进程置为等待信号量 s 的状态；R(s)表示释放一个等待信号量 s 的进程。

在系统初始化时应把 semaphore 定义为某个类型，为简单起见，在模拟实验中可把上 述的 semaphore 直接改成 integer。

（2）生产者——消费者问题。 

假定有一个生产者和消费者，生产者每次生产一件产品，并把生产的产品存入共享缓 冲器以供消费者取走使用。消费者每次从缓冲器内取出一件产品去消费。禁止生产者将产品 放入已满的缓冲器内，禁止消费者从空缓冲器内取产品。假定缓冲器内可同时存放 10 件产 品。那么，用 PV 操作来实现生产者和消费者之间的同步，生产者和消费者两个进程的程序 如下：

~~~
B:array [0..9] of products;
s1,s2: semaphore;
IN, out; integer;
IN:=0;out:=0;
cobegin
procedure producer;
c: products;
begin
L1:
produce (c);
p (s1);
B[IN]:=C;
IN:=(IN+1)mod 10;
v(s2);
goto L1
end;
procedure consumer;
x: products;
begin
L2:P(s2);
x:=B[out];
out:=(out+1) mod 10;
v(s1);
consume(x);
goto L2
end;
coend
~~~

其中的 semaphore 和 products 是预先定义的两个类型，在模拟实现中 semaphore 用 integer 或 char 等代替。

（3）进程控制块 PCB。

为了纪录进程执行时的情况，以及进程让出处理器后的状态，断点等信息，每个进程 都有一个进程控制块 PCB。在模拟实验中，假设进程控制块的结构如 下表。其中进程的状 操作系统实验指导书 10 态有：运行态、就绪态、等待态和完成态。当进程处于等待态时，在进程控制块 PCB 中要说 明进程等待原因（在模拟实验中进程等待原因为等待信号量 s1或 s2）；当进程处于等待态或 就绪态时，PCB 中保留了断点信息，一旦进程再度占有处理器则就从断点位置继续运行；当 进程处于完成状态，表示进程执行结束。

|  进程名  |
| :------: |
|   状态   |
| 等待原因 |
|   断点   |

（4）处理器的模拟。

 计算机硬件提供了一组机器指令，处理器的主要职责是解释执行机器指令。为了模拟 生产者和消费者进程的并发执行，我们必须模拟一组指令和处理器职能。 模拟的一组指令见图 2-2，其中每条指令的功能由一个过程来实现。用变量 PC 来模拟 “指令计数器”，假设模拟的指令长度为 1，每执行一条模拟指令后，PC 加 1，指出下一条 指令地址。使用模拟的指令，可把生产者和消费者进程的程序表示为图 2-3 的形式。 定义两个一维数组 PA[0..4]和 SA[0..4],每一个 PA[i]存放生产者程序中的一条模拟 指令执行的入口地址；每个 SA[i]存放消费者程序中的一条模拟指令执行的入口地址。于是 模拟处理器执行一条指令的过程为：取出 PC 之值，按 PA[PC] 或 SA[PC]得模拟指令执行的 入口地址，将 PC 之值加 1，转向由入口地址确定的相应的过程执行。 

（5）程序设计

 本实验中的程序由三部分组成：初始化程序、处理器调度程序、模拟处理器指令执行程序。



## (3)实现思路

#### P操作原语： 

​			将信号量s-1 ;执行后 若s<0 则让执行的进程设置成等待信号量s的状态

#### V 操作原语 V(s)：

​			将信号量 s + 1，若 s <= 0，则释放一个等待信号量 s 的进程(即让一个等待的进程继续执行(R(s)))。

#### W(s):

​			表示将调用过程的进程置为等待信号量 s 的状态.

#### R(S):

​			表示释放一个等待信号量 s 的进程。

### (1)生产者-消费者问题

##### 生产者

​			生产者一次生产一个产品，并且将产品加入到生产者消费者共享队列中，队列最大长度为10 当队列满时，生产一次后暂停。

##### 消费者：

​			消费者判断共享队列是否为空，如果不为空，则从中取出产品，否则等待生产者生产后从中取出。

### (2)进程控制块PCB

当进程处于等待态时，在进程控制块 PCB 中要说 明进程等待原因（在模拟实验中进程等待原因为等待信号量 s1或 s2)；当进程处于等待态或 就绪态时，PCB 中保留了断点信息，一旦进程再度占有处理器则就从断点位置继续运行；当 进程处于完成状态，表示进程执行结束。

## 源码

点击查看源码(如果打不开请多访问几次，国内访问github容易失败)

